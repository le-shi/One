使用交换机作为公司内部主时间服务器，
一台linux物理机做中转时间服务器，
其他机器做客户端

做了时间同步的监控，当上游时间服务器不可用或者没有启动chrony/ntp服务时，会产生警告

中转服务器几次重启后，都会产生时间同步的警告

ssh到中转服务器，发现 chronyd 服务有这么一行日志 "Source 192.168.10.2 offline"，然后手动重启 chronyd 服务就正常了，警告也消失了

没有找到具体原因，现在通过 `system.timer` 定时任务的方法解决一下

1. 准备 check_chronyd.sh

    ```bash
    # 生成检查脚本
    echo '''#!/bin/bash
    if [[ 0 == $(chronyc sources | grep -c "\^?") ]]
    then
        echo '[INFO] Pass.'
    else
        echo "[WARN] help sb. up [chronyd]"
        systemctl restart chronyd
        echo "[INFO] Repaired, waiting for next inspection."
    fi
    ''' | tee /usr/sbin/check_chronyd.sh
    # 添加执行权限
    chmod +x /usr/sbin/check_chronyd.sh
    ```

2. 准备 check-chronyd.service

    ```bash
    echo '''[Unit]
    Description=check-chronyd

    [Service]
    Type=simple
    ExecStart=/usr/sbin/check_chronyd.sh
    ''' | tee /usr/lib/systemd/system/check-chronyd.service
    ```

3. 准备 check-chronyd.timer

    ```bash
    echo '''[Unit]
    Description=check-chronyd every 1m

    [Timer]
    # 定时器后指定的时间单位可以是：us(微秒), ms(毫秒), s(秒), m(分), h(时), d(天), w(周), month(月), y(年)。如果省略了单位，则表示使用默认单位‘秒’
    # 多少(OnActiveSec)时间后，开始运行
    OnActiveSec=30s
    # 连续运行两次之间的间隔时间
    OnUnitActiveSec=10m
    Unit=check-chronyd.service

    [Install]
    WantedBy=multi-user.target
    ''' | tee /usr/lib/systemd/system/check-chronyd.timer
    ```

4. 启动 check-chronyd.timer

    ```bash
    # 重新加载配置
    systemctl daemon-reload
    # 设置开机自启动并直接启动
    systemctl enable --now check-chronyd.timer
    # 更改timer需要重启
    systemctl restart check-chronyd.timer
    ```

5. 查看服务状态

    ```bash
    # 查看服务状态
    systemctl status check-chronyd.timer check-chronyd.service chronyd.service

    # 查看日志
    journalctl -fe -u check-chronyd
    ```

6. 大功告成，妈妈再也不用担心服务失败的问题了
